<head>
	<link rel="stylesheet" href="/client/css/main.css" />
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<title>CubeJump.io</title>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5016026564626619",
    enable_page_level_ads: true
  });
</script>
</head>
<body>
<div id="startMenuBackground">
</div>
<div id="startMenu">
	<p>Alpha Testing</p>
	<input type="text" tabindex="0" autofocus placeholder="Enter your name here" id="nickname" maxlength="15" /><br>
	<button id="startButton">Play as guest</button><br>
	<button class="loginBtn loginBtn--facebook">Login with Facebook</button>
	<button class="loginBtn loginBtn--google">Login with Google</button>
</div>
<div id="gameDiv" style="display:none;">
	<div id="game">
		<canvas id="canvas" style="position:absolute;border:0px solid #000000;"></canvas>
		<canvas id="ctx-ui" style="position:absolute;border:0px solid #000000;"></canvas>
		<div id="status"><span class="title">Leaderboard</span></div>
	</div>
</div>

<!--<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>-->
<script src="/client/socket.js"></script>
<script>

	var leaderboard = [];

	var canvas = document.getElementById("canvas");
	canvas.width  = window.innerWidth;
	canvas.height = window.innerHeight;
    document.body.scrollTop = 0;
    document.body.style.overflow = 'hidden';
	
	var cvsUI = document.getElementById("ctx-ui");
	cvsUI.width  = window.innerWidth;
	cvsUI.height = window.innerHeight;
    document.body.scrollTop = 0;
    document.body.style.overflow = 'hidden';
	
	// 
	var WIDTH = canvas.width;
	var HEIGHT = canvas.height;
	var socket = io();
	
	//Start Menu
	var startMenu = document.getElementById('startMenu');
	var nickname = document.getElementById('nickname');
	var startButton = document.getElementById('startButton');
	
	startButton.onclick = function(){
		socket.emit('startGame',{username:nickname.value,width:WIDTH,height:HEIGHT});
	}
	socket.on('startGameResponse',function(data){
		startMenu.style.display = 'none';
		startMenuBackground.style.display = 'none';
		gameDiv.style.display = 'inline-block';
	});
	
	socket.on('gameOver',function(){
		startMenu.style.display = 'block';
	});
	
	
	//game
	var ctx = document.getElementById("canvas").getContext("2d");
	var ctxUi = document.getElementById("ctx-ui").getContext("2d");
	ctxUi.font = '30px Arial';

	
	var Player = function(initPack){
		var self = {};
		self.id = initPack.id;
		self.number = initPack.number;
		self.x = initPack.x;
		self.y = initPack.y;
		self.score = initPack.score;
		self.deg = initPack.deg;
		self.gameOver = initPack.gameOver;
		self.width = initPack.width;
		self.height = initPack.height;
		self.color = initPack.color;
		self.username = initPack.username;
		self.scale = initPack.scale;
		
		self.draw = function(){
		
			if(self.gameOver)
				return;
				
			var x = self.x - Player.list[selfId].x + WIDTH/2;
			var y = self.y - Player.list[selfId].y + HEIGHT/2;
			
			
			var width = self.width*self.scale;
			var height = self.height*self.scale;
			
		//	ctx.fillStyle = 'white';
		//	ctx.fillRect(WIDTH/2-width/2,HEIGHT/2-height/2,width,height);
		// use this to see how much it goes into the ground.
			
			ctx.save();
			ctx.translate(x-width/2,y-height/2);
			ctx.translate(width/2,self.height/2);
			ctx.fillStyle = 'white';
			ctx.fillText(self.username,0,0);
			ctx.rotate(self.deg * Math.PI/180);
			ctx.globalAlpha = 0.25;
			ctx.strokeStyle = self.color;
			ctx.fillStyle = self.color;
			ctx.fillRect(-width/2,-height/2,width,height);
			ctx.globalAlpha = 1.0;
			ctx.lineWidth = 3;
			ctx.strokeRect(-width/2,-height/2,width,height);
			ctx.restore();
			
		//	ctx.fillStyle = 'white';
		//	ctx.fillRect(WIDTH/2+self.x,HEIGHT/2+262-self.y,width,height);
		//	ctx.fillRect(WIDTH/2-width/2,HEIGHT/2-3/4*width,width,height);
		
		//	ctx.fillText(self.y,self.x,self.y-60);
		}
		
		Player.list[self.id] = self;
		
		
		return self;
	}
	Player.list = {};

		
	var Mass = function(initPack){
		var self = {};
		self.id = initPack.id;
		self.x = initPack.x;
		self.y = initPack.y;
		self.color = initPack.color;
		self.width = initPack.width;
		
		self.draw = function(){
			var width = self.width * Player.list[selfId].scale/2;
			var height = self.width * Player.list[selfId].scale/2;
			
			var x = self.x - Player.list[selfId].x + WIDTH/2;
			var y = self.y - Player.list[selfId].y + HEIGHT/2;
			
			ctx.globalAlpha = 0.25;
			ctx.strokeStyle = self.color;
			ctx.fillStyle = self.color;
			ctx.fillRect(x-width/2,y-height/2,width,height);
			ctx.globalAlpha = 1.0;
			ctx.lineWidth = 1;
			ctx.strokeRect(x-width/2,y-height/2,width,height);
		}
		
		Mass.list[self.id] = self;		
		return self;
	}
	Mass.list = {};
	
	var selfId = null;

	socket.on('init',function(data){	
		if(data.selfId)
			selfId = data.selfId;
		//{ player : [{id:123,number:'1',x:0,y:0},{id:1,number:'2',x:0,y:0}], mass: []}
		for(var i = 0 ; i < data.player.length; i++){
			new Player(data.player[i]);
		}
		for(var i = 0 ; i < data.mass.length; i++){
			new Mass(data.mass[i]);
		}
	});
	
	socket.on('update',function(data){
		//{ player : [{id:123,x:0,y:0},{id:1,x:0,y:0}], mass: []}
		for(var i = 0 ; i < data.player.length; i++){
			var pack = data.player[i];
			var p = Player.list[pack.id];
			if(p){
				if(pack.x !== undefined)
					p.x = pack.x;
				if(pack.y !== undefined)
					p.y = pack.y;
				if(pack.deg !== undefined)
					p.deg = pack.deg;
				if(pack.scale !== undefined)
					p.scale = pack.scale;
				if(pack.color !== undefined)
					p.color = pack.color;	
				if(pack.gameOver !== undefined)
					p.gameOver = pack.gameOver;
				if(pack.width !== undefined)
					p.width = pack.width;
				if(pack.height !== undefined)
					p.height = pack.height;
				if(pack.score !== undefined)
					p.score = pack.score;
			}
		}
		for(var i = 0 ; i < data.mass.length; i++){
			var pack = data.mass[i];
			var b = Mass.list[data.mass[i].id];
			if(b){
				if(pack.x !== undefined)
					b.x = pack.x;
				if(pack.y !== undefined)
					b.y = pack.y;
				if(pack.color !== undefined)
					b.color = pack.color;
				if(pack.width !== undefined)
					b.width = pack.width;
			}
		}
	});
	
	socket.on('remove',function(data){
		//{player:[12323],mass:[12323,123123]}
		for(var i = 0 ; i < data.player.length; i++){
			delete Player.list[data.player[i]];
			
		}
		for(var i = 0 ; i < data.mass.length; i++){
			delete Mass.list[data.mass[i]];
		}
	});
	
	setInterval(function(){
		if(!selfId)
			return;
		ctx.clearRect(0,0,WIDTH,HEIGHT);
		drawFloor();
		drawScore();
		for(var i in Player.list)
			Player.list[i].draw();
		for(var i in Mass.list)
			Mass.list[i].draw();
	},40);
	
	var drawFloor = function(){
		var player = Player.list[selfId];
		var x = 0 - player.x;
		var y = 0 - player.y;
		var num = HEIGHT/2 + 262;
		ctx.fillStyle = '#101028';
		ctx.fillRect(x,y + num,15000,500);
		ctx.shadowBlur=20;
		ctx.shadowColor="black";
	}
	
	var drawScore = function(){
		if(lastScore === Player.list[selfId].score)
			return;
		lastScore = Player.list[selfId].score;
		ctxUi.clearRect(0,0,500,500);
		ctxUi.fillStyle = 'white';
		ctxUi.fillText(Player.list[selfId].score,0,30);
	}
	var lastScore = null;
	
	document.onkeydown = function(event){
		if(event.keyCode === 37)
			socket.emit('keyPress',{inputId:'right',state:true});
		else if(event.keyCode === 39)	
			socket.emit('keyPress',{inputId:'left',state:true});
		else if(event.keyCode === 32) 
			socket.emit('keyPress',{inputId:'space',state:true});
			
	}
	document.onkeyup = function(event){
		if(event.keyCode === 37)
			socket.emit('keyPress',{inputId:'right',state:false});
		else if(event.keyCode === 39)	
			socket.emit('keyPress',{inputId:'left',state:false});
		else if(event.keyCode === 32)
			socket.emit('keyPress',{inputId:'space',state:false});
	}
	
	document.oncontextmenu = function(event){
		event.preventDefault();
	}

    socket.on('leaderboard', function (data) {
        leaderboard = data.leaderboard;
        var status = '<span class="title">Leaderboard</span>';
        for (var i = 0; i < leaderboard.length; i++) {
            status += '<br />';
            if (leaderboard[i].id == Player.id){
                if(leaderboard[i].username.length !== 0)
                    status += '<span class="me">' + (i + 1) + '. ' + leaderboard[i].username + "</span>";
                else
                    status += '<span class="me">' + (i + 1) + ". An unnamed cube</span>";
            } else {
                if(leaderboard[i].username.length !== 0)
                    status += (i + 1) + '. ' + leaderboard[i].username;
                else
                    status += (i + 1) + '. An unnamed cube';
            }
        }
        //status += '<br />Players: ' + data.players;
        document.getElementById('status').innerHTML = status;
    });	
	
	
</script>
</body>




